<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Burmalda Tycoon Online</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --gold: #f1c40f; --green: #2ecc71; --red: #e74c3c; --bg: #121212; --panel: #1f1f1f; }
        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; text-align: center; user-select: none; overflow: hidden; }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--panel); border-bottom: 2px solid #333; }
        .balance { font-size: 20px; color: var(--gold); font-weight: bold; }
        .energy-bar { font-size: 12px; color: var(--green); }
        .icon-btn { background: #333; border: none; border-radius: 8px; color: white; padding: 8px; font-size: 18px; cursor: pointer; }

        .tab-content { display: none; padding: 20px; height: calc(100vh - 140px); overflow-y: auto; }
        .active-tab { display: block; }

        .click-btn { 
            width: 200px; height: 200px; border-radius: 50%; border: 6px solid #333; 
            background: var(--gold); color: black; font-size: 22px; font-weight: bold;
            box-shadow: 0 0 25px rgba(241, 196, 15, 0.2); margin-top: 40px; transition: transform 0.05s;
        }
        .click-btn:active { transform: scale(0.92); }

        .slot-machine { display: flex; justify-content: center; gap: 8px; margin: 15px 0; }
        .slot { width: 60px; height: 75px; background: #000; border-radius: 8px; border: 2px solid var(--gold); font-size: 35px; line-height: 75px; overflow: hidden; }
        .spinning { animation: slotSpin 0.1s infinite linear; }
        @keyframes slotSpin { 0% { transform: translateY(-2px); filter: blur(3px); } 100% { transform: translateY(2px); filter: blur(0px); } }

        .list-item { background: var(--panel); padding: 12px; margin: 8px 0; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--gold); text-align: left; }
        .buy-btn { background: var(--green); border: none; color: white; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; }

        .nav { position: fixed; bottom: 0; width: 100%; background: var(--panel); display: flex; height: 70px; border-top: 1px solid #333; }
        .nav-btn { flex: 1; background: none; border: none; color: #777; font-size: 11px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .nav-btn.active { color: var(--gold); font-weight: bold; }

        input { background: #333; color: white; border: 1px solid #444; padding: 10px; border-radius: 8px; width: 70%; margin: 10px; text-align: center; }
    </style>
</head>
<body onload="initApp()">

<div class="top-bar">
    <div>
        <div class="balance"><span id="coins">0</span> ü™ô</div>
        <div class="energy-bar">‚ö° <span id="energy">1000</span>/1000</div>
    </div>
    <div style="display: flex; gap: 8px;">
        <button class="icon-btn" onclick="openTab('shop', this)">üõí</button>
        <button class="icon-btn" onclick="openTab('settings', this)">‚öôÔ∏è</button>
        <button class="icon-btn" onclick="openTab('profile', this)">üë§</button>
    </div>
</div>

<div id="tab-clicker" class="tab-content active-tab">
    <div id="status-msg" style="height: 20px; color: var(--red); font-size: 14px; margin-bottom: 10px; font-weight: bold;"></div>
    <button class="click-btn" onclick="makeClick()">–ë–£–†–ú–ê–õ–î–ê</button>
    <p id="multiplier-info" style="color: var(--gold); font-size: 12px; margin-top: 15px;"></p>
</div>

<div id="tab-games" class="tab-content">
    <div style="background: var(--panel); padding: 15px; border-radius: 15px; border: 1px solid #333;">
        <h3>–ö–ê–ó–ò–ù–û</h3>
        <div class="slot-machine">
            <div class="slot" id="s1">üé∞</div><div class="slot" id="s2">üé∞</div><div class="slot" id="s3">üé∞</div>
        </div>
        <input type="number" id="bet-amount" placeholder="–°—Ç–∞–≤–∫–∞">
        <button onclick="playCasino()" style="width: 100%; padding: 12px; background: var(--red); border: none; border-radius: 8px; color: white; font-weight: bold;">–ö–†–£–¢–ò–¢–¨</button>
        <p style="font-size: 10px; color: #666; margin-top: 10px;">x100 (1%) | x5 (10%) | x2 (20%)</p>
    </div>
</div>

<div id="tab-realty" class="tab-content">
    <h3>–ù–ï–î–í–ò–ñ–ò–ú–û–°–¢–¨</h3>
    <div class="list-item"><div><b>–õ–∞—á—É–≥–∞</b><span>+5/—Å–µ–∫</span></div><button class="buy-btn" onclick="buyRealty(0, 2000)">2000</button></div>
    <div class="list-item"><div><b>–•—Ä—É—â–µ–≤–∫–∞</b><span>+20/—Å–µ–∫</span></div><button class="buy-btn" onclick="buyRealty(1, 10000)">10000</button></div>
    <div class="list-item"><div><b>–ü–µ–Ω—Ç—Ö–∞—É—Å</b><span>+100/—Å–µ–∫</span></div><button class="buy-btn" onclick="buyRealty(2, 50000)">50000</button></div>
</div>

<div id="tab-shop" class="tab-content">
    <h3>–ú–ê–ì–ê–ó–ò–ù</h3>
    <div class="list-item"><div><b>–°–∞–ª–∞—Ç–∏–∫</b><span>+500 ‚ö°</span></div><button class="buy-btn" onclick="buyItem('salad', 400)">400</button></div>
    <div class="list-item"><div><b>–°—É–ø—á–∏–∫</b><span>+700 ‚ö°</span></div><button class="buy-btn" onclick="buyItem('soup', 600)">600</button></div>
</div>

<div id="tab-profile" class="tab-content">
    <h3>–í–ê–® –ü–†–û–§–ò–õ–¨</h3>
    <div style="text-align: left; background: #222; padding: 20px; border-radius: 12px; border: 1px solid #444;">
        <p>üë§ –ò–º—è: <span id="p-name" style="color:var(--gold)">Loading...</span></p>
        <p>üí∞ –î–æ—Ö–æ–¥: <span id="p-income" style="color:var(--green)">0</span> /—Å–µ–∫</p>
        <p>üèÜ –í—Å–µ–≥–æ: <span id="p-total">0</span></p>
    </div>
    <button onclick="showLeaderboard()" style="width:100%; margin-top:20px; padding:15px; background: var(--gold); border:none; border-radius:10px; font-weight:bold; cursor:pointer;">üèÜ –õ–ò–î–ï–†–ë–û–†–î</button>
</div>

<div id="tab-settings" class="tab-content">
    <h3>–ù–ê–°–¢–†–û–ô–ö–ò</h3>
    <div style="background:#222; padding:15px; border-radius:10px;">
        <p>–ó–≤—É–∫: <input type="checkbox" id="s-sound" checked style="width:20px;"></p>
        <p>–í–∏–±—Ä–æ: <input type="checkbox" id="s-haptic" checked style="width:20px;"></p>
    </div>
    <button onclick="localStorage.clear(); location.reload();" style="margin-top:20px; color:#666; background:none; border:none; text-decoration:underline;">–°–±—Ä–æ—Å –ª–æ–∫–∞–ª–∫–∏</button>
</div>

<div class="nav">
    <button class="nav-btn active" onclick="openTab('clicker', this)">üñ±Ô∏è –ö–ª–∏–∫</button>
    <button class="nav-btn" onclick="openTab('games', this)">üé≤ –ò–≥—Ä—ã</button>
    <button class="nav-btn" onclick="openTab('realty', this)">üè¢ –î–æ–º–∞</button>
</div>

<script>
    const S_URL = 'https://hccddilanmfdyxhwhxou.supabase.co';
    const S_KEY = 'EyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhjY2RkaWxhbm1mZHl4aHdoeG91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyNjc5MzksImV4cCI6MjA4Nzg0MzkzOX0.HDQtwUH63Qe5pNOP7r9aeygAlndEmUKB9klmd-MARvo';
    const supabaseClient = supabase.createClient(S_URL, S_KEY);

    let coins = 0, energy = 1000, income = 0, totalEarned = 0, clickMult = 1, isSpinning = false;
    const tg = window.Telegram.WebApp;
    const user = tg.initDataUnsafe.user || { id: 777, username: 'LocalPlayer' };

    const sounds = {
        click: new Audio('click.mp3'), win: new Audio('win.mp3'), 
        loss: new Audio('loss.mp3'), mellfan: new Audio('mellfan.mp3'),
        salad: new Audio('salad.mp3'), soup: new Audio('soup.mp3')
    };

    function playSnd(n) { if(document.getElementById('s-sound').checked) { sounds[n].currentTime=0; sounds[n].play().catch(()=>{}); } }
    function doHaptic() { if(document.getElementById('s-haptic').checked && tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light'); }

    async function initApp() {
        tg.expand();
        document.getElementById('p-name').innerText = user.username || 'Anon';
        await loadFromCloud();
        setInterval(saveToCloud, 8000); 
        setInterval(() => { if(income > 0) { coins += income; totalEarned += income; updateUI(); } }, 1000);
    }

    async function loadFromCloud() {
        let { data, error } = await supabaseClient.from('profiles').select('*').eq('id', user.id).single();
        if (data) {
            coins = data.coins; energy = data.energy; income = data.income; totalEarned = data.total_earned;
            updateUI();
        } else {
            await supabaseClient.from('profiles').insert([{ id: user.id, username: user.username, coins: 0 }]);
        }
    }

    async function saveToCloud() {
        await supabaseClient.from('profiles').update({ 
            coins: Math.floor(coins), energy, income, total_earned: Math.floor(totalEarned) 
        }).eq('id', user.id);
    }

    function updateUI() {
        document.getElementById('coins').innerText = Math.floor(coins);
        document.getElementById('energy').innerText = energy;
        document.getElementById('p-income').innerText = income;
        document.getElementById('p-total').innerText = Math.floor(totalEarned);
    }

    function makeClick() {
        if(energy <= 0) { showMsg("–ù–µ—Ç ‚ö°"); return; }
        if(Math.random() < 0.005) { coins = Math.max(0, coins-100); playSnd('mellfan'); showMsg("MELLFAN -100"); }
        else { coins += 1*clickMult; totalEarned += 1*clickMult; energy--; playSnd('click'); doHaptic(); }
        updateUI();
    }

    function playCasino() {
        if(isSpinning) return;
        let bet = parseInt(document.getElementById('bet-amount').value);
        if(!bet || bet > coins) return tg.showAlert("–ú–∞–ª–æ –º–æ–Ω–µ—Ç!");
        isSpinning = true; coins -= bet; updateUI();
        const slots = [document.getElementById('s1'), document.getElementById('s2'), document.getElementById('s3')];
        slots.forEach(s => s.classList.add('spinning'));
        setTimeout(() => {
            slots.forEach(s => s.classList.remove('spinning'));
            let r = Math.random()*100;
            let res = (r < 1) ? ['üíé','üíé','üíé'] : (r < 11) ? ['üçã','üçã','üçã'] : (r < 31) ? ['üçí','üçí','üçí'] : ['üí©','ü§°','7Ô∏è‚É£'];
            if(r < 1) coins += bet*100; else if(r < 11) coins += bet*5; else if(r < 31) coins += bet*2;
            slots[0].innerText = res[0]; slots[1].innerText = res[1]; slots[2].innerText = res[2];
            (r < 31) ? playSnd('win') : playSnd('loss');
            isSpinning = false; updateUI();
        }, 1200);
    }

    function buyRealty(idx, p) { if(coins >= p) { coins -= p; income += (idx==0?5:(idx==1?20:100)); updateUI(); playSnd('click'); } else tg.showAlert("–î–µ–Ω–µ–≥ –Ω–µ—Ç!"); }
    function buyItem(id, p) { if(coins >= p) { coins -= p; playSnd(id); if(id=='salad') energy = Math.min(1000, energy+500); else energy = Math.min(1000, energy+700); updateUI(); } }

    function openTab(name, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active-tab'));
        document.getElementById('tab-' + name).classList.add('active-tab');
        if(btn.classList.contains('nav-btn')) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
    }

    async function showLeaderboard() {
        let { data } = await supabaseClient.from('profiles').select('username, coins').order('coins', {ascending: false}).limit(5);
        let str = "üèÜ –¢–û–ü –ë–£–†–ú–ê–õ–î–ò–ù–û–í:\n" + data.map((p, i) => `${i+1}. ${p.username || 'Anon'}: ${Math.floor(p.coins)}`).join('\n');
        tg.showAlert(str);
    }

    function showMsg(t) { let m = document.getElementById('status-msg'); m.innerText = t; setTimeout(()=>m.innerText="", 2000); }
</script>
</body>
</html>
